---
title: "KB국민은행 유동성 가상계좌 시스템 구축"
order: 11
startDate: "2019-03-01"
endDate: "2019-05-31"
description: "체납자 통합 가상계좌 및 유동적 납부 시스템 구축"
tags: ["JavaScript", "jQuery", "Java", "Spring", "Oracle"]
company: "유채널"
---

## 프로젝트 개요

관리자 대시보드 및 가상계좌 데몬을 구현하여 표준지방세를 납부하지 않은 단건/대량 체납자 정보를 엑셀 업로드하면 가상계좌 데몬이 이를 인지하고 가상계좌를 채번/발급합니다.

체납자는 1건 이상의 고지자료를 발급받은 **하나의 가상계좌 번호**를 통해 체납 금액에 구애받지 않고 수납 처리를 할 수 있게 됩니다. 수납된 정보는 관리자 대시보드에서 확인 가능하며, 관리자는 고지자료의 우선순위 또는 금액에 따라 납부 처리를 하여 업무의 효율성을 높일 수 있도록 시스템을 구축했습니다.

## 프로젝트 정보

- **고객사**: KB국민은행, 지방자치단체
- **포지션**: Front/Back-end
- **개발 인원**: 5명

## 기술 스택

- **Frontend**: JavaScript, jQuery
- **Backend**: Java, Spring Framework
- **Database**: Oracle
- **Server**: Linux, Windows

## 핵심 특징

### **유동성 가상계좌의 차별점**

기존 가상계좌 시스템과 달리, 유동성 가상계좌는 다음과 같은 특징을 가집니다:

- **통합 가상계좌**: 1개의 가상계좌 번호로 여러 건의 고지자료 납부 가능
- **유동적 금액 납부**: 체납 금액에 구애받지 않고 원하는 금액만큼 납부 가능
- **우선순위 관리**: 관리자가 고지자료의 납부 우선순위를 설정
- **과금 자동 분배**: 납부 금액을 우선순위/금액에 따라 자동으로 각 고지자료에 분배

## 업무 프로세스

### 1. **가상계좌 매핑 (웹 화면)**

체납자 정보를 대량으로 업로드하여 통합 가상계좌를 발급하는 프로세스입니다.

```mermaid
sequenceDiagram
    autonumber
    participant Admin as 관리자
    participant Web as 웹 화면
    participant DB as Oracle DB
    participant Daemon as 가상계좌<br/>데몬
    participant VA_API as 가상계좌<br/>발급 API
    participant Tax as 표준지방세외수입<br/>정보시스템

    Note over Admin,Tax: 가상계좌 매핑 프로세스

    Admin->>Web: 체납자 목록 파일 업로드<br/>(Excel/CSV)
    Web->>DB: 업로드 파일 저장<br/>(임시 파일 테이블)
    DB-->>Web: 저장 완료
    Web-->>Admin: 업로드 완료

    Note over Daemon,VA_API: 데몬 자동 처리

    Daemon->>DB: 신규 업로드 파일 조회<br/>(주기적 폴링)
    DB-->>Daemon: 미처리 파일 목록

    activate Daemon

    loop 각 파일별 처리
        Daemon->>Daemon: Direct Buffer로 파일 읽기
        Daemon->>Daemon: 데이터 검증<br/>(필수항목, 형식, 중복)

        alt 검증 실패
            Daemon->>DB: 검증 오류 저장
        else 검증 성공
            Daemon->>DB: 체납자 정보 저장

            loop 각 체납자별 처리
                Daemon->>Tax: 고지자료 조회
                Tax-->>Daemon: 고지정보 목록<br/>(고지번호, 금액 등)

                Daemon->>VA_API: 통합 가상계좌 채번 요청
                VA_API-->>Daemon: 가상계좌 번호 발급

                Daemon->>DB: 가상계좌 매핑 저장
                Daemon->>DB: 고지자료 연결
                Daemon->>DB: 우선순위 설정
            end
        end

        Daemon->>DB: 파일 처리 완료 상태 업데이트
    end

    deactivate Daemon

    Web->>DB: 발급 현황 조회
    DB-->>Web: 완료 건수/실패 건수
    Web-->>Admin: 발급 결과 표시
```

**프로세스 플로우**:

1. **체납자 목록 업로드**
   - `.excel` 또는 `.csv` 형태의 파일 업로드
   - 체납자 정보 검증 (필수 항목, 형식 등)
   - 중복 체크

2. **통합 가상계좌 채번**
   - 가상계좌 데몬이 업로드된 파일 감지
   - 체납자별 통합 가상계좌 번호 자동 채번
   - 가상계좌 발급 및 매핑 처리

3. **고지자료 연결**
   - 체납자의 모든 고지자료를 하나의 가상계좌에 연결
   - 납부 우선순위 설정
   - 발급 완료 알림

### 2. **가상계좌 납부 (실시간 서비스)**

체납자가 통합 가상계좌로 납부 시 처리하는 서비스입니다.

```mermaid
sequenceDiagram
    autonumber
    participant User as 체납자
    participant Host as KB 호스트<br/>시스템
    participant Service as 수납 처리<br/>서비스
    participant Tax as 표준지방세외수입<br/>정보시스템
    participant DB as Oracle DB

    Note over User,DB: 가상계좌 납부 프로세스

    User->>Host: 통합 가상계좌로 입금<br/>(전체 금액의 일부 가능)
    Host->>Service: 가상계좌 거래 발생<br/>(가상계좌번호, 납부 금액)

    activate Service

    Service->>DB: 가상계좌 정보 조회
    DB-->>Service: 체납자 정보, 매핑 정보

    Service->>Tax: 원장 데이터 조회<br/>(모든 고지자료)
    Tax-->>Service: 고지정보 목록<br/>(고지번호, 미납 금액, 우선순위)

    Service->>Service: 납부 금액 검증<br/>(최소 금액 이상)

    alt 유효하지 않은 금액
        Service-->>Host: 거래 거부
        Host-->>User: 납부 불가 안내
    else 유효한 금액
        Note over Service: 우선순위 기반 금액 분배

        Service->>Service: 우선순위 정렬
        Service->>Service: 금액 분배 계산

        loop 각 고지자료별
            Service->>Service: 분배 금액 계산<br/>(우선순위 높은 순)

            alt 분배 금액 있음
                Service->>Tax: 수납 자료 전송<br/>(고지번호, 수납 금액)
                Tax-->>Service: 수납 완료 응답
                Service->>DB: 수납 내역 저장
            end
        end

        Service->>Service: 잔액 확인

        alt 잔액 존재 (과금)
            Service->>DB: 입금 반환 대상 등록
            Note right of Service: 입금 반환<br/>프로세스 진행
        end

        Service->>DB: 납부 완료 상태 업데이트
        Service-->>Host: 수납 완료 응답
        deactivate Service

        Host-->>User: 납부 완료 안내<br/>(분배 내역)
    end
```

**프로세스 플로우**:

1. **가상계좌 거래 발생**
   - KB국민은행 호스트 시스템에서 거래 발생
   - 납부 금액 확인 (전체 체납액보다 적은 금액도 가능)

2. **표준지방세외수입정보시스템 원장 데이터 조회**
   - 가상계좌번호로 연결된 모든 고지정보 조회
   - 각 고지자료의 미납 금액 확인

3. **수납 자료 전송**
   - 우선순위에 따라 납부 금액 자동 분배
   - 각 고지자료별 수납 처리
   - 표준지방세외수입정보시스템으로 수납 완료 전송

### 3. **입금 반환 (웹/서비스)**

수납 시 과금된 금액을 반환하는 프로세스입니다.

```mermaid
sequenceDiagram
    autonumber
    participant Admin as 관리자
    participant Web as 웹 화면
    participant Service as 입금 반환<br/>서비스
    participant DB as Oracle DB
    participant Host as KB 호스트<br/>시스템
    participant File as 결과 파일<br/>시스템

    Note over Admin,File: 입금 반환 프로세스

    Admin->>Web: 입금 반환 메뉴 진입
    Web->>DB: 과금 수납건 조회
    DB-->>Web: 반환 대상 목록<br/>(과금 금액, 체납자 정보)
    Web-->>Admin: 반환 대상 표시

    Admin->>Web: 반환 건 선택<br/>입금 계좌 입력/조회
    Web->>Service: 입금 반환 요청

    activate Service

    Service->>DB: 계좌 정보 조회

    alt 계좌 미등록
        DB-->>Service: 계좌 없음
        Service-->>Web: 계좌 등록 필요
        Web-->>Admin: 계좌 정보 입력 요청
        Admin->>Web: 계좌번호 입력
        Web->>Service: 계좌 정보 등록
        Service->>DB: 계좌 정보 저장
    else 계좌 등록됨
        DB-->>Service: 입금 계좌 정보
    end

    Service->>Service: 반환 금액 계산
    Service->>Service: 입금 반환 전문 생성<br/>(고정 길이 포맷)

    Service->>Host: 전문 파일 전송<br/>(입금 반환 요청)

    activate Host
    Host->>Host: 반환 처리<br/>(계좌 이체)
    Host->>File: 결과 파일 생성
    deactivate Host

    Note over Service,File: 결과 파일 처리 (비동기)

    Service->>File: 결과 파일 폴링
    File-->>Service: 반환 결과 파일

    Service->>Service: 파일 파싱<br/>(고정 길이/CSV)

    loop 각 반환 건별
        Service->>Service: 결과 코드 확인

        alt 반환 성공
            Service->>DB: 반환 완료 상태 업데이트
            Service->>DB: 반환 이력 저장
        else 반환 실패
            Service->>DB: 실패 이력 저장
            Service->>DB: 재처리 대상 등록
        end
    end

    Service-->>Web: 반환 처리 완료
    deactivate Service

    Web->>DB: 처리 결과 조회
    DB-->>Web: 성공/실패 건수
    Web-->>Admin: 결과 리포트 표시<br/>(성공 건, 실패 건)

    alt 실패 건 존재
        Admin->>Web: 실패 건 상세 조회
        Web-->>Admin: 실패 사유 표시<br/>(수동 처리 안내)
    end
```

**프로세스 플로우**:

1. **과금 수납건 선별**
   - 수납 금액이 고지 금액을 초과한 건 조회
   - 반환 대상 금액 계산
   - 반환 대상 목록 생성

2. **입금 계좌번호 조회/등록**
   - 체납자의 입금 계좌 정보 조회
   - 미등록 시 계좌 정보 등록 화면 제공
   - 계좌 유효성 검증

3. **입금 반환 처리**
   - 입금 반환 서비스 호출
   - 호스트 시스템과 연계하여 반환 처리
   - 반환 완료 결과 DB 저장 및 알림

### 4. **일일대사**

각 시스템 간의 수납 자료를 동기화하여 데이터 정합성을 보장합니다.

```mermaid
sequenceDiagram
    autonumber
    participant Batch as 일일대사<br/>배치
    participant Host as KB 호스트<br/>시스템
    participant VA_DB as 가상계좌<br/>시스템 DB
    participant Tax as 표준지방세외수입<br/>정보시스템
    participant Report as 대사 결과<br/>리포트

    Note over Batch,Report: 일일대사 프로세스 (매일 자동 실행)

    activate Batch

    Note over Batch,Tax: 1단계: 데이터 수집

    Batch->>Host: 전일 거래 내역 조회
    Host-->>Batch: 호스트 거래 데이터<br/>(거래번호, 금액, 시간)

    Batch->>VA_DB: 전일 수납 내역 조회
    VA_DB-->>Batch: 가상계좌 수납 데이터<br/>(수납번호, 분배 금액, 고지번호)

    Batch->>Tax: 전일 수납 내역 조회
    Tax-->>Batch: 표준시스템 수납 데이터<br/>(고지번호, 수납 금액)

    Note over Batch,Report: 2단계: 데이터 대사

    Batch->>Batch: 3개 시스템 데이터 매칭

    loop 각 거래별 대사
        Batch->>Batch: 거래번호 기준 매칭

        alt 호스트 거래 금액 확인
            Batch->>Batch: 호스트 입금액 = A
        end

        alt 가상계좌 수납 내역 확인
            Batch->>Batch: 분배 금액 합계 = B
            Batch->>Batch: 각 고지별 분배 금액
        end

        alt 표준시스템 수납 확인
            Batch->>Batch: 각 고지별 수납 금액 = C
        end

        Batch->>Batch: 정합성 검증<br/>(A = B = C)

        alt 일치
            Batch->>Report: 정상 건 기록
        else 불일치
            Batch->>Batch: 불일치 유형 분석

            alt 호스트 ≠ 가상계좌
                Batch->>Report: 분배 오류 기록<br/>(원인: 금액 분배 로직 오류)
            else 가상계좌 ≠ 표준시스템
                Batch->>Report: 수납 전송 오류 기록<br/>(원인: 표준시스템 연계 실패)
            else 3개 시스템 모두 불일치
                Batch->>Report: 심각 오류 기록<br/>(원인: 시스템 간 동기화 실패)
            end

            Batch->>Report: 불일치 상세 정보 저장<br/>(거래번호, 각 시스템 금액, 차액)
        end
    end

    Note over Batch,Report: 3단계: 결과 처리

    Batch->>Batch: 대사 결과 집계<br/>(총 건수, 일치 건수, 불일치 건수)

    Batch->>Report: 일일대사 리포트 생성
    Report-->>Batch: 리포트 생성 완료

    alt 불일치 건 존재
        Batch->>Report: 불일치 건 상세 리포트
        Batch->>Batch: 관리자 알림 발송<br/>(이메일/SMS)
        Note right of Batch: 수동 확인 및<br/>조치 필요
    else 전체 일치
        Batch->>Report: 정상 완료 리포트
    end

    Batch->>VA_DB: 대사 결과 DB 저장
    Batch->>Batch: 배치 완료 로그 기록

    deactivate Batch

    Note over Batch,Report: 관리자는 웹 화면에서 대사 결과 확인 가능
```

**프로세스 플로우**:

1. **3개 시스템 수납 자료 조회**
   - 호스트 시스템 거래 내역
   - 가상계좌 시스템 수납 내역
   - 표준지방세외수입정보시스템 수납 내역

2. **데이터 대사**
   - 거래 건수 및 금액 비교
   - 분배 금액 정합성 검증
   - 불일치 건 확인 및 리포트

## 담당 업무

### 1. **가상계좌 매핑**

체납자 정보 업로드 및 가상계좌 발급 기능을 구현했습니다.

#### **가상계좌 매핑 화면 설계/구현**

- **파일 업로드 UI**
  - Drag & Drop 방식의 파일 업로드
  - 엑셀/CSV 파일 형식 검증
  - 업로드 진행률 표시

- **데이터 검증**
  - 필수 항목 검증 (체납자명, 주민번호, 고지번호 등)
  - 데이터 형식 검증 (날짜, 금액 등)
  - 중복 체크 및 에러 표시
  - 검증 실패 건 상세 리포트

- **매핑 결과 화면**
  - 가상계좌 발급 현황 조회
  - 발급 완료/실패 통계
  - 엑셀 다운로드 기능

#### **대용량 파일 파싱 성능 개선**

대량의 엑셀/CSV 파일을 처리할 때 발생하는 성능 이슈를 해결했습니다.

**문제 상황**:
- 수만 건 이상의 체납자 정보 업로드 시 파싱 시간 과다 소요
- 메모리 부족 및 타임아웃 발생
- 사용자 대기 시간 증가

**해결 방안**:

**Direct Buffer를 활용한 파일 파싱**

### 2. **입금 반환 서비스**

과금된 금액을 반환하는 서비스를 구현했습니다.

#### **호스트 전문 처리**

- **입금 반환 전문 생성**
  - 반환 대상 계좌 정보 수집
  - 고정 길이 전문 포맷 생성
  - 전문 헤더/바디 구성

- **전문 송수신**
  - 파일 통신을 통한 호스트 연계
  - 타임아웃 처리 및 재전송 로직
  - 응답 전문 파싱

- **에러 핸들링**
  - 계좌 오류, 금액 오류 등 비즈니스 에러 처리
  - 통신 오류 재시도 로직
  - 에러 로그 및 알림

#### **전문 결과 파일 to DB 처리**

- **결과 파일 수신**
  - 호스트에서 생성한 반환 결과 파일 수신
  - 파일 포맷 검증 (고정 길이, CSV 등)

- **DB 적재**
  - 결과 파일 파싱
  - 반환 성공/실패 건 구분
  - Oracle DB 배치 Insert
  - 트랜잭션 관리

- **결과 처리**
  - 반환 완료 건 상태 업데이트
  - 실패 건 재처리 또는 수동 처리 안내

### 3. **대시보드 관리 및 권한 설정 화면 설계/구현**

관리자를 위한 통합 대시보드 및 권한 관리 화면을 구축했습니다.

#### **대시보드 관리**

- **실시간 모니터링**
  - 오늘의 수납 현황 (건수, 금액)
  - 가상계좌 발급 현황
  - 입금 반환 처리 현황

- **통계 차트**
  - jQuery 기반 차트 라이브러리 활용
  - 일/주/월별 수납 통계
  - 체납자별 납부 현황
  - 고지자료별 수납률

- **업무 관리**
  - 가상계좌 조회 및 관리
  - 고지자료 우선순위 설정
  - 수납 내역 조회 및 취소
  - 입금 반환 대상 관리

## 개발 구현 내용

### Frontend 개발

1. **jQuery 기반 관리자 화면**
   - 가상계좌 매핑 화면
   - 입금 반환 관리 화면
   - 대시보드 및 통계 화면

2. **파일 업로드 컴포넌트**
   - Drag & Drop 파일 업로드
   - 업로드 진행률 표시
   - 파일 검증 및 에러 표시

3. **대시보드 차트**
   - 실시간 업데이트 차트

### Backend 개발

4. **Spring Framework**
   - Spring MVC 패턴
   - RESTful API 설계

5. **가상계좌 매핑 시스템**
   - 가상계좌 데몬 구현
   - 통합 가상계좌 채번 로직
   - Direct Buffer 기반 파일 파싱

6. **유동적 납부 처리 시스템**
   - 우선순위 기반 금액 분배 로직
   - 실시간 수납 처리
   - 다건 고지자료 동시 처리

7. **입금 반환 시스템**
   - 과금 건 자동 선별
   - 호스트 전문 통신
   - 결과 파일 파싱 및 DB 적재

### Database 개발

9. **Oracle DB**
   - 통합 가상계좌 테이블 설계
   - 고지자료 우선순위 테이블
   - 입금 반환 테이블

### 시스템 통합

10. **외부 시스템 연동**
    - KB국민은행 호스트 시스템 연동
    - 표준지방세외수입정보시스템 연동
    - 전문 통신 및 파일 연계
