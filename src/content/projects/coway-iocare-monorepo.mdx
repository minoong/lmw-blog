---
title: 'IoCare+ / NECOA 모노레포 통합'
order: 7
startDate: '2025-02-01'
endDate: '2025-07-31'
description: 'Turborepo + pnpm workspace로 멀티 브랜드 서비스 코드베이스 통합, Changesets 기반 패키지 배포 자동화'
tags: ['Turborepo', 'pnpm', 'Monorepo', 'Changesets', 'esbuild', 'tsup', 'GitHub Actions', 'OpenAPI Generator', 'AWS Secrets Manager', 'CI/CD']
company: "코웨이"
---

## 프로젝트 개요

IoCare+ 한국 법인과 NECOA 미국 법인의 분리된 레파지토리에서 중복 발생하던 컴포넌트, CLI, 유틸, 커스텀 훅을 공통 패키지로 분리하여 Turborepo + pnpm workspace 기반 모노레포로 통합 관리했습니다. Changesets를 활용한 시맨틱 버저닝, esbuild/tsup 기반 패키지 빌드 최적화, GitHub Actions 배포 자동화 파이프라인을 구축했습니다.

## 배경

### 문제 상황

**코드 중복 문제**:
- IoCare+ 레파지토리와 NECOA 레파지토리에 동일한 컴포넌트 중복 존재
- 커스텀 훅, 유틸 함수, CLI 도구가 각 레파지토리에 중복 관리
- 한쪽 레파지토리에서 버그 수정 시 다른 레파지토리에 수동 반영 필요

**의존성 관리 복잡성**:
- 각 레파지토리가 독립적으로 의존성 관리
- 동일한 라이브러리의 버전 불일치 발생
- 공통 로직 변경 시 양쪽 레파지토리에 배포 필요

**개발 도구 자동화 필요성**:
- OpenAPI 스펙 변경 시 타입 정의를 레파지토리별로 업데이트
- Google Sheets 번역 데이터를 레파지토리별로 S3/CDN에 배포

### 모노레포

- Turborepo + pnpm workspace로 모노레포 구축
- 공통 패키지 및 브랜드별 앱 패키지 분리
- Changesets 기반 시맨틱 버저닝 자동화
- esbuild/tsup로 패키지 빌드 최적화
- OpenAPI Generator, Google Sheets CLI 자동화 도구 개발
- GitHub Actions로 빌드/배포/버저닝 파이프라인 구축

## 기술 스택

- **Monorepo**: Turborepo, pnpm workspace
- **Versioning**: Changesets
- **Build**: esbuild, tsup
- **Type Generation**: OpenAPI Generator
- **Automation**: Custom CLI (Google Sheets API, AWS S3)
- **CI/CD**: GitHub Actions, GitHub Packages

## 모노레포 구조

### 패키지 구성

```
webapp-monorepo/
├── apps/
│   ├── a-webapp/          # A 법인 앱
│   └── b-webapp/          # B 법인 앱
├── packages/
│   ├── ui/                # 공통 UI 컴포넌트
│   ├── hooks/             # 공통 커스텀 훅
│   ├── utils/             # 공통 유틸 함수
│   ├── types/             # 공통 TypeScript 타입
│   ├── cli/               # 자동화 CLI 도구
│   ├── eslint-config/     # 공통 ESLint 설정
│   ├── prettier-config/   # 공통 Prettier 설정
│   └── tsconfig/          # 공통 TypeScript 설정
├── turbo.json             # Turborepo 설정
├── pnpm-workspace.yaml    # pnpm workspace 설정
└── .changeset/            # Changesets 설정
```

## 주요 구현 내용

### 1. Turborepo + pnpm workspace 구축

멀티 브랜드 서비스를 단일 모노레포로 통합

**pnpm-workspace.yaml**:
```yaml
packages:
  - 'apps/*'
  - 'packages/*'
```

**turbo.json**:
```json
{
  "$schema": "https://turbo.build/schema.json",
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "dist/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {
      "dependsOn": ["^lint"]
    },
    "type-check": {
      "dependsOn": ["^type-check"]
    }
  }
}
```

**장점**:
- 병렬 빌드로 빌드 시간 최적화
- 변경된 패키지만 선택적 빌드 (Incremental Build)
- 캐싱으로 중복 작업 제거

### 2. 공통 패키지 분리

중복 코드를 공통 패키지로 분리

#### packages/ui

공통 UI 컴포넌트 패키지 - 컴파운드 패턴 적용

**컴파운드 패턴 구현**:
- 복잡한 컴포넌트를 작은 서브 컴포넌트로 분리
- 부모-자식 관계를 명확히 하여 유연한 조합 가능
- Context API를 활용한 props 전달 및 Context 접근 커스텀 훅 설계/구현
- 예시: `BottomSheet.Container`, `BottomSheet.Header`, `BottomSheet.Content`

**Storybook 문서화**:
- 모든 공통 컴포넌트에 대한 Storybook 작성
- 컴파운드 패턴별 사용 예시 제공
- 인터랙션 테스트 포함
- 앱 독립적으로 컴포넌트 개발 및 테스트 가능

#### packages/hooks

커스텀 훅 패키지

#### packages/utils

유틸 함수 패키지 - vitest 테스트 환경 구축

**vitest 적용**:
- 모든 유틸 함수에 대한 단위 테스트 작성
- 코드 커버리지 (70% 이상)
- Github Actions 로 Pull Reqeust 시 자동 테스트 실행

#### packages/eslint-config, packages/tsconfig

설정 패키지

- ESLint, Prettier, TypeScript 공통 설정

### 3. esbuild/tsup 패키지 빌드 최적화

esbuild 기반 빌드 도구 적용

- esbuild 기반 빠른 빌드 속도
- TypeScript 타입 정의(d.ts) 자동 생성 편리
- CJS/ESM 포맷 지원
- Tree-shaking 자동 적용

**package.json 설정**:
```json
{
  "name": "@iocare/ui",
  "version": "1.0.0",
  "main": "./dist/index.js",
  "module": "./dist/index.mjs",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.mjs",
      "require": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  },
  "scripts": {
    "build": "tsup",
    "dev": "tsup --watch"
  }
}
```

### 4. Changesets 기반 버저닝 자동화

패키지 변경 시 시맨틱 버저닝 자동 관리

**.changeset/config.json**:
```json
{
  "$schema": "https://unpkg.com/@changesets/config@2.3.0/schema.json",
  "changelog": "@changesets/cli/changelog",
  "commit": false,
  "fixed": [],
  "linked": [],
  "access": "restricted",
  "baseBranch": "main",
  "updateInternalDependencies": "patch",
  "ignore": []
}
```

### 5. CLI 패키지 구성 및 실행 설정

자동화 도구를 CLI 패키지로 통합하여 npx로 실행 가능하도록 구성하여 터미널 어느 위치에서든 실행 가능하도록 설정

- **OpenAPI Generator 타입 자동 생성 CLI**
  - 옵션을 입력받아 백엔드 url 및 결과 파일 경로 지정
- **Google Sheets 다국어 자동화 CLI**
  - 인증 처리
  - 브랜드별 Google Sheets, AWS S3, AWS CloudFront (invalidation) 기존 config 설정 처리
- **AWS Secrets Manager 환경변수 파일 생성 CLI**
  - AWS Secrets Manager 환경변수 조회
  - Next.js 프로젝트별 `.env.*` 파일 자동 생성
  - 브랜드별(IoCare+ / NECOA) Secret 분리 관리
  - 로컬 개발 환경 설정 자동화

**packages/cli/package.json**:
```json
{
  "name": "@webapp/cli",
  "version": "1.0.0",
  "bin": {
    "generate-types": "./dist/generate-types.js",
    "sync-i18n": "./dist/sync-i18n.js",
    "create-env": "./dist/create-env.js"
  },
  "scripts": {
    "build": "tsup",
    "dev": "tsup --watch"
  },
  "dependencies": {
    "@openapitools/openapi-generator-cli": "^2.7.0",
    "googleapis": "^118.0.0",
    "@aws-sdk/client-s3": "^3.400.0",
    "@aws-sdk/client-secrets-manager": "^3.400.0"
  }
}
```

**packages/cli/tsup.config.ts**:
```typescript
import { defineConfig } from 'tsup';

export default defineConfig({
  entry: {
    'generate-types': 'src/generate-types.ts',
    'sync-i18n': 'src/sync-i18n.ts',
    'create-env': 'src/create-env.ts',
  },
  format: ['cjs', 'esm'],
  dts: false,
  shebang: {
    'generate-types': '#!/usr/bin/env node',
    'sync-i18n': '#!/usr/bin/env node',
    'create-env': '#!/usr/bin/env node',
  },
  clean: true,
});
```

**실행 방법**:
```bash
# 루트에서 실행
pnpm --filter @webapp/cli generate-types
pnpm --filter @webapp/cli sync-i18n

# 또는 npx로 실행
npx @webapp/cli generate-types
npx @webapp/cli sync-i18n
```

### 7. GitHub Actions 빌드/배포/버저닝 파이프라인

CI/CD 자동화

### 8. GitHub Packages 배포

GitHub Packages로 프라이빗 패키지 배포

**.npmrc**:
```
@webapp:registry=https://npm.pkg.github.com
//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}
```

**apps/a-webapp/package.json**:
```json
{
  "name": "a-webapp",
  "dependencies": {
    "@iocare/ui": "workspace:*",
    "@iocare/hooks": "workspace:*",
    "@iocare/utils": "workspace:*",
    "@iocare/types": "workspace:*"
  }
}
```

- 프라이빗 패키지를 GitHub 내에서 안전하게 관리
- GitHub 권한으로 패키지 접근 제어
